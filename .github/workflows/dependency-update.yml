name: Dependency Updates

on:
  schedule:
    # æ¯å‘¨ä¸€ä¸Šåˆ 9:00 UTC (åŒ—äº¬æ—¶é—´ 17:00) æ£€æŸ¥ä¾èµ–æ›´æ–°
    - cron: '0 9 * * 1'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  check-backend-deps:
    name: Check Backend Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Check for security vulnerabilities
        run: |
          cd backend
          pip-audit --requirement requirements.txt --format json --output audit-results.json || true

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        with:
          name: backend-security-audit
          path: backend/audit-results.json

      - name: Create issue if vulnerabilities found
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            try {
              const auditResults = JSON.parse(fs.readFileSync('backend/audit-results.json', 'utf8'));

              if (auditResults.vulnerabilities && auditResults.vulnerabilities.length > 0) {
                const vulnCount = auditResults.vulnerabilities.length;
                const criticalCount = auditResults.vulnerabilities.filter(v => v.severity === 'critical').length;
                const highCount = auditResults.vulnerabilities.filter(v => v.severity === 'high').length;

                const issueBody = `## ğŸ” åç«¯ä¾èµ–å®‰å…¨æ¼æ´æŠ¥å‘Š

**æ£€æµ‹æ—¶é—´:** ${new Date().toISOString()}

**æ¼æ´ç»Ÿè®¡:**
- ğŸ”´ Critical: ${criticalCount}
- ğŸŸ  High: ${highCount}
- ğŸŸ¡ Medium: ${vulnCount - criticalCount - highCount}
- **æ€»è®¡:** ${vulnCount}

**å—å½±å“çš„åŒ…:**

${auditResults.vulnerabilities.slice(0, 10).map(v =>
  \`- \\\`${v.name}\\\` (${v.version}): ${v.summary}\`
).join('\\n')}

${vulnCount > 10 ? '\\n...è¿˜æœ‰æ›´å¤šæ¼æ´,è¯·æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š' : ''}

**å»ºè®®æªæ–½:**
1. è¿è¡Œ \`pip-audit --fix\` è‡ªåŠ¨ä¿®å¤
2. æ‰‹åŠ¨æ›´æ–° requirements.txt ä¸­çš„åŒ…ç‰ˆæœ¬
3. æµ‹è¯•æ›´æ–°åçš„ä¾èµ–æ˜¯å¦å…¼å®¹

**è¯¦ç»†æŠ¥å‘Š:** æŸ¥çœ‹ Actions artifacts

---
ğŸ¤– æ­¤ Issue ç”±è‡ªåŠ¨åŒ–æ£€æŸ¥ç”Ÿæˆ`;

                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: \`[Security] Backend ä¾èµ–å‘ç° ${vulnCount} ä¸ªå®‰å…¨æ¼æ´\`,
                  body: issueBody,
                  labels: ['ğŸ” security', 'dependencies', 'priority: high', 'âš™ï¸ backend']
                });
              }
            } catch (error) {
              console.log('No vulnerabilities found or error reading results');
            }

  check-frontend-deps:
    name: Check Frontend Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Run npm audit
        run: |
          cd frontend
          npm audit --json > audit-results.json || true

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        with:
          name: frontend-security-audit
          path: frontend/audit-results.json

      - name: Check for outdated packages
        run: |
          cd frontend
          npm outdated --json > outdated.json || true

      - name: Create issue if vulnerabilities found
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            try {
              const auditResults = JSON.parse(fs.readFileSync('frontend/audit-results.json', 'utf8'));

              const vulnCount = auditResults.metadata?.vulnerabilities?.total || 0;
              const criticalCount = auditResults.metadata?.vulnerabilities?.critical || 0;
              const highCount = auditResults.metadata?.vulnerabilities?.high || 0;
              const moderateCount = auditResults.metadata?.vulnerabilities?.moderate || 0;

              if (vulnCount > 0) {
                const issueBody = \`## ğŸ” å‰ç«¯ä¾èµ–å®‰å…¨æ¼æ´æŠ¥å‘Š

**æ£€æµ‹æ—¶é—´:** ${new Date().toISOString()}

**æ¼æ´ç»Ÿè®¡:**
- ğŸ”´ Critical: ${criticalCount}
- ğŸŸ  High: ${highCount}
- ğŸŸ¡ Moderate: ${moderateCount}
- **æ€»è®¡:** ${vulnCount}

**å»ºè®®æªæ–½:**
1. è¿è¡Œ \\\`npm audit fix\\\` è‡ªåŠ¨ä¿®å¤
2. å¦‚æœè‡ªåŠ¨ä¿®å¤å¤±è´¥,è¿è¡Œ \\\`npm audit fix --force\\\`
3. æ‰‹åŠ¨æ£€æŸ¥æ˜¯å¦æœ‰ breaking changes
4. æµ‹è¯•æ›´æ–°åçš„åº”ç”¨

**æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š:**
\\\`\\\`\\\`bash
cd frontend
npm audit
\\\`\\\`\\\`

---
ğŸ¤– æ­¤ Issue ç”±è‡ªåŠ¨åŒ–æ£€æŸ¥ç”Ÿæˆ\`;

                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: \`[Security] Frontend ä¾èµ–å‘ç° ${vulnCount} ä¸ªå®‰å…¨æ¼æ´\`,
                  body: issueBody,
                  labels: ['ğŸ” security', 'dependencies', 'priority: high', 'ğŸ¨ frontend']
                });
              }
            } catch (error) {
              console.log('No vulnerabilities found or error reading results');
            }

  dependabot-auto-merge:
    name: Auto-merge Dependabot PRs
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'

    steps:
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-approve minor and patch updates
        if: steps.metadata.outputs.update-type == 'version-update:semver-minor' || steps.metadata.outputs.update-type == 'version-update:semver-patch'
        run: gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-merge minor and patch updates
        if: steps.metadata.outputs.update-type == 'version-update:semver-minor' || steps.metadata.outputs.update-type == 'version-update:semver-patch'
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
