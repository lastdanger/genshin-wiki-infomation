name: PR Auto Labeler

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

jobs:
  label-pr:
    name: Auto Label Pull Request
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Label based on modified files
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml
          sync-labels: true

      - name: Label based on branch name
        uses: TimonVS/pr-labeler-action@v4
        with:
          configuration-path: .github/pr-labeler.yml
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Add size label
        uses: pascalgn/size-label-action@v0.5.3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          sizes: >
            {
              "0": "size/XS",
              "10": "size/S",
              "50": "size/M",
              "200": "size/L",
              "500": "size/XL",
              "1000": "size/XXL"
            }

      - name: Check for breaking changes
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            const title = pr.title || '';

            // Check for breaking change indicators
            const hasBreakingChange =
              body.toLowerCase().includes('breaking change') ||
              title.toLowerCase().includes('breaking') ||
              body.includes('BREAKING CHANGE:');

            if (hasBreakingChange) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['‚ö†Ô∏è breaking change']
              });
            }

      - name: Add priority label based on title
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title.toLowerCase();

            let priorityLabel = null;

            if (title.includes('[p0]') || title.includes('critical') || title.includes('hotfix')) {
              priorityLabel = 'priority: critical';
            } else if (title.includes('[p1]') || title.includes('urgent')) {
              priorityLabel = 'priority: high';
            } else if (title.includes('[p2]')) {
              priorityLabel = 'priority: medium';
            } else if (title.includes('[p3]')) {
              priorityLabel = 'priority: low';
            }

            if (priorityLabel) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: [priorityLabel]
              });
            }

      - name: Check if PR is ready for review
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;

            // Check if PR is marked as draft
            if (pr.draft) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['üöß work in progress']
              });
            } else {
              // Remove WIP label if PR is no longer draft
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  name: 'üöß work in progress'
                });
              } catch (error) {
                // Label might not exist
              }
            }
