name: Project Board Automation

on:
  issues:
    types: [opened, closed, reopened, assigned]
  pull_request:
    types: [opened, closed, reopened, converted_to_draft, ready_for_review, review_requested]
  pull_request_review:
    types: [submitted]

jobs:
  update-project-status:
    name: Update Project Board Status
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write

    steps:
      - name: Update issue status
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const action = context.payload.action;

            console.log(`Issue #${issue.number} ${action}`);

            // æ ¹æ® issue çŠ¶æ€æ›´æ–°é¡¹ç›®çœ‹æ¿
            // æ³¨æ„: éœ€è¦ä½¿ç”¨ GraphQL API æ¥æ›´æ–° Projects v2
            // è¿™é‡Œæä¾›åŸºæœ¬çš„çŠ¶æ€æ˜ å°„é€»è¾‘

            let projectStatus = null;

            if (action === 'opened') {
              projectStatus = 'Backlog';
              console.log('Moving to Backlog');
            } else if (action === 'assigned') {
              projectStatus = 'In Progress';
              console.log('Moving to In Progress');
            } else if (action === 'closed') {
              projectStatus = 'Done';
              console.log('Moving to Done');
            } else if (action === 'reopened') {
              projectStatus = 'Ready';
              console.log('Moving to Ready');
            }

            if (projectStatus) {
              // Add comment to indicate status change
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `ğŸ¤– é¡¹ç›®çŠ¶æ€å·²æ›´æ–°: **${projectStatus}**`
              });
            }

      - name: Update PR status
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const action = context.payload.action;

            console.log(`PR #${pr.number} ${action}`);

            let projectStatus = null;

            if (action === 'opened' && pr.draft) {
              projectStatus = 'In Progress';
              console.log('Draft PR - Moving to In Progress');
            } else if (action === 'opened' && !pr.draft) {
              projectStatus = 'Review';
              console.log('PR opened - Moving to Review');
            } else if (action === 'ready_for_review') {
              projectStatus = 'Review';
              console.log('Ready for review - Moving to Review');
            } else if (action === 'converted_to_draft') {
              projectStatus = 'In Progress';
              console.log('Converted to draft - Moving to In Progress');
            } else if (action === 'closed' && pr.merged) {
              projectStatus = 'Done';
              console.log('PR merged - Moving to Done');
            } else if (action === 'closed' && !pr.merged) {
              projectStatus = 'Backlog';
              console.log('PR closed without merge - Moving to Backlog');
            }

            if (projectStatus) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `ğŸ¤– é¡¹ç›®çŠ¶æ€å·²æ›´æ–°: **${projectStatus}**`
              });
            }

      - name: Update status on PR review
        if: github.event_name == 'pull_request_review'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const review = context.payload.review;
            const pr = context.payload.pull_request;

            console.log(`PR #${pr.number} reviewed: ${review.state}`);

            if (review.state === 'approved') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `âœ… PR å·²é€šè¿‡å®¡æ ¸,å‡†å¤‡è¿›å…¥æµ‹è¯•é˜¶æ®µ\n\nğŸ¤– é¡¹ç›®çŠ¶æ€å·²æ›´æ–°: **Testing**`
              });
            } else if (review.state === 'changes_requested') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `âš ï¸ PR éœ€è¦ä¿®æ”¹,å·²ç§»å›å¼€å‘é˜¶æ®µ\n\nğŸ¤– é¡¹ç›®çŠ¶æ€å·²æ›´æ–°: **In Progress**`
              });
            }

  sync-linked-issues:
    name: Sync Linked Issues Status
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    permissions:
      issues: write
      pull-requests: read

    steps:
      - name: Close linked issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';

            // Extract issue references from PR body
            const issueRefs = body.match(/(close|closes|closed|fix|fixes|fixed|resolve|resolves|resolved)\s+#(\d+)/gi);

            if (issueRefs) {
              for (const ref of issueRefs) {
                const issueNumber = parseInt(ref.match(/#(\d+)/)[1]);

                console.log(`Closing issue #${issueNumber}`);

                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  state: 'closed'
                });

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: `âœ… å·²é€šè¿‡ PR #${pr.number} ä¿®å¤å¹¶åˆå¹¶åˆ°ä¸»åˆ†æ”¯`
                });
              }
            }
